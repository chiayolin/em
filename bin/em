#!/usr/bin/env bash
ID=$(date +%s)
LOG="../em-$ID.log"

init_dir () {
  DIR="em-$ID"
  echo "id: $DIR"
  mkdir $DIR && cd $DIR
}

init_man () {
  man -k . | awk '{print $1}' | grep "(1)" | \
    sed 's/(1)//g' | sed 's/,//g' | xargs touch

  echo "$(($(ls -l | wc -l) - 1)) man pages found."
}

_check_man () {
  man "$1" > /dev/null 2>&1 || \
    echo "warning: $1 not found." >> $LOG
}

_export_man () { 
  man $1 2>> $LOG | col -b 1> $1 || \
    return 5 
}

_add_extension () {
  for FILE in *; do
    mv "$FILE" "$FILE.txt"
  done
}

export_man () {
  for COMMAND in *; do
    _check_man $COMMAND && _export_man $COMMAND
  done
  _add_extension || return 6
  
  return $?
}

write_log () {
  tee -a $LOG
}

error_handling () {
  local prefix="error: unable to"
  case $1 in
    3) echo "$prefix create directory: $DIR" | \
      write_log
      ;;
    4) echo "$prefix scan or create man files" | \
      write_log
      ;;
    5) echo "$prefix export $COMMAND's man page" | \
      write_log
      ;;
    6) echo "$prefix add extension to exported mans" | \
      write_log
      ;;
    *) echo "error: unknown error(s) :(" | \
      write_log
      ;;
  esac
}

main () {
  echo "initializing..."
  init_dir || return 3
  echo "scanning..."
  init_man || return 4

  echo "exporting..."
  return $(export_man)
}

main || error_handling $?
echo "done in $(($(date +%s) - ID)) seconds." | \
  tee -a $LOG
